window.VisualisationWidget=window.VisualisationWidget||{},function(n){function c(t,i){i&&i.detail&&i.detail.detailedMessage?i=i.detail.detailedMessage:i&&i.responseJSON&&i.responseJSON.ResponseStatus&&i.responseJSON.ResponseStatus.Message&&(i=i.responseJSON.ResponseStatus.Message);var r=n.embeds[t].visualisationsOptions,u='<p style="display: block; text-align: center;">'+i+"<\/p>",f=$("#"+r.visualErrorContainerId);f.append(u);ft(r)}var t;n.embeds=n.embeds||{};n.initWidget=function(i){l().then(function(){return p(i)}).then(function(){return b(i.visualContainerId),VisualisationWidgetScreenshot.setEncodedEmbedKey(i.visualContainerId,n.embeds),t()}).then(function(){if(!i.isDesignMode&&!i.disableScreenshot){var r=VisualisationWidgetScreenshot.getEncodedEmbedUrl(i.screenshotCdnEndpoint,i.visualContainerId,n.embeds);return VisualisationWidgetScreenshot.existsEmbedScreenshot(r).then(function(n){return n&&(et(i.visualContainerId),ut(i.visualContainerId)),t()})}return t()}).then(function(){return r(i.visualContainerId)}).then(function(n){return u(i.visualContainerId,n.Token),t()}).then(function(){return a(i.visualContainerId)}).then(function(){return it(i.visualContainerId)}).then(function(){return g(i.visualContainerId)}).then(function(){return i.filters!=null?k(i.visualContainerId):t()}).then(function(){return i.skipVisualHeaderConfiguration?t():tt(i.visualContainerId)}).then(function(){return!i.appliedMobileLayout&&i.pageName!=null&&i.pageName!==""&&i.selectedVisuals!=null&&i.selectedVisuals.length>0&&i.layoutColumns!=null?w(i.visualContainerId):t()}).then(function(){return i.disableScreenshot||VisualisationWidgetScreenshot.generateEmbedScreenshot(i.visualContainerId,n.embeds,VisualisationWidgetBookmark.captureBookmark),t()}).then(function(){return i.hasThemes&&i.visualisationThemeItemId!=null&&n.handleTheme(i.visualContainerId,i.visualisationThemeItemId),t()}).then(function(){return i.bookmarkState!=null&&i.bookmarkState!==""?nt(i.visualContainerId):t()}).then(function(){return setTimeout(s,1e3,i.visualContainerId),t()},function(n){c(i.visualContainerId,n)});o(i.visualParentContainerId,i.useMobileLayout);$(window).resize(function(){o(i.visualParentContainerId,i.useMobileLayout)})};t=function(){var n=$.Deferred();return n.resolve(),n.promise()};var r=function(t){var i=$.Deferred(),u=window.sf_appPath||"/",r=n.embeds[t].visualisationsOptions,f=u+"restapi/powerbi/getembedtoken/"+r.serviceAccountName+"/"+r.workspaceId+"/"+r.reportId;return $.ajax({method:"GET",url:f,headers:{"Cache-Control":"max-age=1800"}}).done(function(n){i.resolve(n.Result)}).fail(function(n){i.reject(n)}),i.promise()},l=function(){var t=$.Deferred(),i;if(typeof n.powerbiPreloaded=="undefined"&&typeof n.powerbiPreloading=="undefined"){n.powerbiPreloading=!0;i=powerbi.preload({type:"report",embedUrl:"https://app.powerbi.com/reportEmbed"});$(i).on("preloaded",function(){n.powerbiPreloaded=!0;t.resolve()})}else t.resolve();return t.promise()},a=function(t){var f=$.Deferred(),i=n.embeds[t].visualisationsOptions,u={type:i.type,tokenType:powerbimodels.TokenType.Embed,accessToken:i.embedToken,embedUrl:i.embedUrl,id:i.reportId,permissions:powerbimodels.Permissions.Read,viewMode:powerbimodels.ViewMode.View,settings:{filterPaneEnabled:i.filterPaneEnabled,navContentPaneEnabled:i.navContentPaneEnabled,bookmarksPaneEnabled:i.bookmarksPaneEnabled,localeSettings:{language:i.language}}},e,r;if(i.pageName!=null&&i.pageName!==""&&(u.pageName=i.pageName),i.applyFiltersOnLoad&&i.filters!=null&&i.filters.reportFilters!=null&&i.filters.reportFilters.length>0&&(u.filters=i.filters.reportFilters),i.slicers!=null&&(u.slicers=i.slicers),i.useMobileLayout){const n=window.matchMedia("(min-width: 1020px)"),t=Bowser.getParser(window.navigator.userAgent).getPlatformType(!0)==="desktop";n.matches||t||(u.settings.layoutType=powerbimodels.LayoutType.MobilePortrait,i.appliedMobileLayout=!0)}e=$("#"+i.visualContainerId)[0];r=powerbi.embed(e,u);n.embeds[t].config=u;r.off("loaded");r.on("loaded",function(){f.resolve()});r.off("rendered");r.on("rendered",function(){r.off("rendered");s(t)});r.on("error",function(n){if(n.detail!=null&&n.detail.message==="mobileLayoutError"){i.appliedMobileLayout=!1;return}f.reject(n)});return f.promise()},v=function(n){var t=$.Deferred(),r=$("#"+n)[0],i=powerbi.get(r);return i!=null?i.refresh().then(function(){t.resolve()}).catch(function(n){t.reject(n)}):t.resolve(),t.promise()},y=function(t){var i=$.Deferred(),r=n.embeds[t].visualisationsOptions,f=$("#"+t)[0],u=powerbi.get(f);return r!=null&&u!=null?u.setAccessToken(r.embedToken).then(function(){console.log("Report view embed token was updated.");i.resolve()}).catch(function(n){i.reject(n)}):i.resolve(),i.promise()},p=function(t){var i=$.Deferred();return n.embeds[t.visualContainerId]={visualisationsOptions:t},i.resolve(),i.promise()},u=function(t,i){n.embeds[t].visualisationsOptions.embedToken=i},w=function(t){var r=$.Deferred(),i=n.embeds[t].visualisationsOptions,f=$("#"+t)[0],u=powerbi.get(f);if(u){let f=$("#"+t).height(),h=f*(16/9),e=h/i.layoutColumns,c=e*(9/16),l=i.selectedVisuals;const p=Math.ceil(l.length/i.layoutColumns);f=Math.max(f,p*c);let o=0,a=0,v={};l.forEach(function(n){v[n]={x:o,y:a,width:e,height:c,displayState:{mode:powerbimodels.VisualContainerDisplayMode.Visible}};o+=e;Number(Number(o+e).toFixed(2))>Number(Number(h).toFixed(2))&&(o=0,a+=c)});let y={};y[i.pageName]={defaultLayout:{displayState:{mode:powerbimodels.VisualContainerDisplayMode.Hidden}},visualsLayout:v};let s={layoutType:powerbimodels.LayoutType.Custom,customLayout:{pageSize:{type:powerbimodels.PageSizeType.Custom,width:h,height:f},displayOption:powerbimodels.DisplayOption.FitToPage,pagesLayout:y}};f!==$("#"+t).height()&&(s.customLayout.displayOption=powerbimodels.DisplayOption.ActualSize);s.background=powerbimodels.BackgroundType.Default;n.embeds[i.visualContainerId].layoutSettings=s;u.updateSettings(s).then(function(){r.resolve()}).catch(function(n){r.reject(n)})}else r.reject();return r.promise()},b=function(t){var i=window.location.href,r=h(i,"filter"),f=h(i,"value"),u;r&&(u=n.embeds[t].visualisationsOptions.filters,u.reportFilters.forEach(function(n){const t=n.target.table.replace(/\s/g,"");r===t&&(n.operator="Contains",n.values=[f])}))},i=function(n){var t=$.Deferred(),i=$("#"+n)[0],r=powerbi.get(i);return r.getPages().then(function(n){t.resolve(n)}).catch(function(n){t.reject(n)}),t.promise()},f=function(n){var t=$.Deferred();return i(n).then(function(n){var i;n.forEach(function(n,t){if(n.isActive){i=t;return}});t.resolve(i)},function(n){t.reject(n)}),t.promise()},st=function(n,t,i){var r=$.Deferred(),e=$("#"+n)[0],o=powerbi.get(e),u,f;return o&&t&&t.length>0?(u=[],f=[],t.forEach(function(n){var t=n.hasLayout(i).then(function(t){f.push({page:n.name,hasLayout:t})});u.push(t)}),Promise.all(u).then(function(){r.resolve(f)}).catch(function(n){r.reject(n)})):r.resolve(),r.promise()},k=function(t){var r=$.Deferred(),f=n.embeds[t].visualisationsOptions,u=f.filters;return u?f.applyFiltersOnLoad?i(t).then(function(n){return e(t,n,u.pageFilters).then(function(){r.resolve()}).catch(function(n){r.reject(n)})}):d(t,u.reportFilters).then(function(){return i(t).then(function(n){return e(t,n,u.pageFilters).then(function(){r.resolve()}).catch(function(n){r.reject(n)})})}):r.resolve(),r.promise()},d=function(n,t){var i=$.Deferred(),u=$("#"+n)[0],r=powerbi.get(u);return r&&t&&t.length>0?r.setFilters(t).then(function(){i.resolve()}).catch(function(n){i.reject(n)}):i.resolve(),i.promise()},e=function(n,t,i){var r=$.Deferred(),f=$("#"+n)[0],e=powerbi.get(f),u;return e&&t&&t.length>0&&i&&i.length>0?(u=[],t.forEach(function(n){var t=i.filter(function(t){return t.page===n.name}),r;t.length>0&&t[0].filters&&t[0].filters.length>0&&(r=n.setFilters(t[0].filters),u.push(r))}),Promise.all(u).then(function(){r.resolve()}).catch(function(n){r.reject(n)})):r.resolve(),r.promise()},g=function(t){var i=$.Deferred(),u=n.embeds[t].visualisationsOptions,f=$("#"+t)[0],r=powerbi.get(f);return r?r.bookmarksManager.getBookmarks().then(function(n){var t=[],f;n.forEach(function(n){n.displayName.startsWith("INIT_")&&t.push(r.bookmarksManager.apply(n.name))});u.bookmarkName!==null&&u.bookmarkName!==""&&(f=u.bookmarkName.split(","),f.forEach(function(i){var u=n.filter(function(n){return n.name===i});u.length>0&&t.push(r.bookmarksManager.apply(i))}));Promise.all(t).then(function(){i.resolve()}).catch(function(n){i.reject(n)})}).catch(function(n){i.reject(n)}):i.reject(),i.promise()},nt=function(t){var i=$.Deferred(),r=n.embeds[t].visualisationsOptions,f=$("#"+r.visualContainerId)[0],u=powerbi.get(f);return u?u.bookmarksManager.applyState(r.bookmarkState).then(function(){i.resolve()}).catch(function(n){i.reject(n)}):i.reject(),i.promise()},tt=function(t){var i=$.Deferred(),u=n.embeds[t].visualisationsOptions,f=$("#"+t)[0],r=powerbi.get(f);if(r){const n={visualSettings:{visualHeaders:[{settings:{visible:u.showAllVisualHeaders}}]}};r.updateSettings(n).then(function(){i.resolve()}).catch(function(n){i.reject(n)})}else i.reject();return i.promise()},it=function(n){var t=$.Deferred(),r=$("#"+n)[0],i=powerbi.get(r);i.off("error");i.on("error",function(t){rt(t,n)});return t.resolve(),t.promise()},rt=function(n,i){const f=n.detail;f.message===powerbimodels.CommonErrorCodes.TokenExpired&&r(i).then(function(n){return u(i,n.Token),t()}).then(function(){return y(i)}).then(function(){return v(i)})};n.seeFullScreen=function(n){var t=$("#"+n)[0],i=powerbi.get(t);i.fullscreen()};var o=function(n,t){var i=$("#"+n);const r=window.matchMedia("(min-width: 1020px)"),u=Bowser.getParser(window.navigator.userAgent).getPlatformType(!0)==="desktop";!t||r.matches||u?(i.removeClass("power-bi-nine-sixteen"),i.addClass("power-bi-sixteen-nine")):(i.removeClass("power-bi-sixteen-nine"),i.addClass("power-bi-nine-sixteen"))},s=function(t){var i=n.embeds[t].visualisationsOptions,f=$("#"+t),r=$("#"+i.visualScreenshotContainerId),u=$("#"+i.placeholderContainerId);f.removeClass("power-bi-visualisation-hidden");r.addClass("power-bi-fade-out");u.addClass("power-bi-fade-out");r.one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(){r.addClass("power-bi-screenshot-hidden")});u.one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(){u.addClass("power-bi-loader-hidden")});ot(i.visualContainerId)},ut=function(t){var i=n.embeds[t].visualisationsOptions,r=$("#"+i.visualScreenshotContainerId),u=$("#"+i.placeholderContainerId);r.removeClass("power-bi-screenshot-hidden");u.addClass("power-bi-loader-hidden")},ft=function(n){var t=$("#"+n.visualErrorContainerId),i=$("#"+n.visualScreenshotContainerId),r=$("#"+n.placeholderContainerId);t.removeClass("power-bi-error-hidden");i.addClass("power-bi-screenshot-hidden");r.addClass("power-bi-loader-hidden")},et=function(t){var i=n.embeds[t].visualisationsOptions,r=VisualisationWidgetScreenshot.getEncodedEmbedUrl(i.screenshotCdnEndpoint,i.visualContainerId,n.embeds),u=$("#"+i.visualScreenshotContainerId);u.children("img").attr("src",r)},ot=function(n){var t=$('[sf-data-visualisation-id="'+n+'"]');t.each(function(){$(this).removeAttr("disabled")})},h=function(n,t){var i=new RegExp("[?&]"+t+"=([^&#]*)").exec(n);return i==null?null:decodeURI(i[1])||0};n.handleTheme=function(t,i){VisualisationWidgetTheme.handleTheme(t,i,n.embeds)};n.saveBookmark=function(t){VisualisationWidgetBookmark.saveBookmark(t,n.embeds)};n.changeVisualisation=function(n,t){$(document).trigger("changeVisualisation",{visualContainerId:n,visualisationName:t})};n.exportExcel=function(t){VisualisationWidgetDataExport.exportExcel(t,n.embeds)};n.exportPdf=function(t){VisualisationWidgetExport.exportPdf(t,n.embeds,VisualisationWidgetBookmark.captureBookmark,f)};n.exportPng=function(t){VisualisationWidgetExport.exportPng(t,n.embeds,VisualisationWidgetBookmark.captureBookmark,f)}}(VisualisationWidget);